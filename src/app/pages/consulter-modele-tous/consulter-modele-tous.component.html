<main class="modeles-container">

  <div class="top-header">
    <div class="actions-par-role">
      <a [routerLink]="'/consulter-modeles'" [ngClass]="{'active-link': router.url === '/consulter-modeles'}">Consulter</a>
      <a *ngIf="!isConsultant" [routerLink]="'/visualiser'" [ngClass]="{'active-link': router.url === '/visualiser'}">Visualiser</a>
      <a *ngIf="isGestionnaire" [routerLink]="'/gerer'" [ngClass]="{'active-link': router.url === '/gerer'}">Gérer</a>
    </div>

    <div class="notif-wrapper" *ngIf="isGestionnaire">
      <button class="notif-btn" (click)="ouvrirPopup()" title="Demandes d'habilitation en attente">
        <i class="fas fa-bell"></i>
        <span class="badge" [ngClass]="{ 'rouge': utilisateurs.length > 0, 'vert': utilisateurs.length === 0 }">
          {{ utilisateurs.length }}
        </span>
      </button>
      <div class="popup-notifs" *ngIf="popupVisible">
        <p *ngIf="utilisateurs.length === 0">Aucune demande de validation.</p>
        <ul *ngIf="utilisateurs.length > 0">
          <li *ngFor="let user of utilisateurs">
            {{ user.nom }} {{ user.prenom }} - {{ user.email }}
            <button (click)="activer(user)">Activer</button>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <p class="role-info">
    Connecté en tant que :
    <strong [ngClass]="{
      'role-gestionnaire': isGestionnaire,
      'role-exploitant': isExploitant,
      'role-consultant': isConsultant
    }">
      {{ isGestionnaire ? 'Gestionnaire' : (isExploitant ? 'Exploitant' : 'Consultant') }}
    </strong>
  </p>
  <div class="filters-wrapper">
    <div class="filters-zone">
      <div class="input-icon">
        <i class="fas fa-file-alt"></i>
        <input type="text" placeholder="Modèle" [(ngModel)]="searchText" (input)="applyFilters()" />
      </div>
      <div class="input-icon">
        <i class="fas fa-calendar-alt"></i>
        <input type="number" min="2000" max="2099" placeholder="Année" [(ngModel)]="searchYear" (input)="applyFilters()" />
      </div>
      <div class="input-icon large-input">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Recherche avancée" [(ngModel)]="advancedSearch" (input)="applyFilters()" />
      </div>
    </div>

    <div class="reset-icon">
      <button class="reset-btn" (click)="resetFilters()">
        <i class="fas fa-sync-alt"></i> Réinitialiser
      </button>
    </div>
  </div>

  <div class="table-controls">
    <div class="entries-per-page">
      <span>Entrées par page</span>
      <select [(ngModel)]="entriesPerPage" (change)="setEntriesPerPage(entriesPerPage)">
        <option [value]="5">5</option>
        <option [value]="10">10</option>
        <option [value]="15">15</option>
      </select>
    </div>
  </div>

  <div class="table-wrapper">
    <table class="models-table">
      <thead>
      <tr>
        <th>Nom du modèle</th>
        <th class="center">Année</th>
        <th class="center">Format</th>
        <th class="center actions-col">Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let modele of paginatedModeles">
        <td>{{ modele.nom }}</td>
        <td class="center">{{ modele.annee }}</td>
        <td class="center">Document</td>
        <td class="center actions-col">
          <button class="btn-icon view" (click)="openDetails(modele)"><i class="fas fa-eye"></i></button>
          <button class="btn-icon edit" [disabled]="!isGestionnaire" [routerLink]="['/modifier-modele', modele.id]"><i class="fas fa-edit"></i></button>
          <button class="btn-icon delete" [disabled]="!isGestionnaire"><i class="fas fa-trash-alt"></i></button>
          <button class="btn-icon add" [disabled]="!isGestionnaire" [routerLink]="['/ajouter-modele']"><i class="fas fa-plus"></i></button>
        </td>
      </tr>
      </tbody>
    </table>

    <div class="table-footer">
      <span>
        Affichage de {{ (currentPage - 1) * entriesPerPage + 1 }} à
        {{ currentPage * entriesPerPage > filteredModeles.length ? filteredModeles.length : currentPage * entriesPerPage }}
        sur {{ filteredModeles.length }} entrées
      </span>
      <div class="pagination">
        <button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">❮</button>
        <button *ngIf="currentPage > 3" (click)="goToPage(1)">1</button>
        <span *ngIf="currentPage > 4">...</span>
        <button *ngFor="let page of visiblePages" (click)="goToPage(page)" [class.active]="currentPage === page">{{ page }}</button>
        <span *ngIf="currentPage < totalPages - 3">...</span>
        <button *ngIf="currentPage < totalPages - 2" (click)="goToPage(totalPages)">{{ totalPages }}</button>
        <button (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">❯</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showModal">
    <div class="modal-card">
      <h3>Détails du modèle</h3>

      <div class="modal-section">
        <strong>Nom du fichier :</strong> {{ selectedModel.nom }}
      </div>

      <div class="modal-section">
        <strong>Année :</strong> {{ selectedModel.annee }}
      </div>

      <div class="modal-section">
        <strong>Format :</strong> {{ selectedModel.format }}
      </div>

      <div class="modal-section">
        <strong>Statut :</strong>
        <span [ngClass]="{ 'used': selectedModel.utilise, 'unused': !selectedModel.utilise }">
        {{ selectedModel.utilise ? 'Utilisé dans une convention' : 'Non encore utilisé' }}
      </span>
      </div>

      <div class="modal-section">
        <details>
          <summary><strong>Variables attendues ({{ expectedVariables.length }})</strong></summary>
          <ul class="variables-list">
            <li *ngFor="let variable of expectedVariables">{{ variable }}</li>
          </ul>
        </details>
      </div>

      <button class="modal-close-btn" (click)="closeModal()">Fermer</button>
    </div>
  </div>
</main>
